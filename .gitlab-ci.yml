stages:
  - build
  - dockerise

cache:
  paths:
    - node_modules/

build:
  image: node:14
  stage: build
  script:
    - yarn install
    - yarn build
    - yarn test
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    paths:
      - game/dist
      - ui/dist

docker:
  stage: dockerise
  image: docker
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl jq python3 py3-pip
    - pip install awscli
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - $(aws ecr get-login --no-include-email --region us-east-1)
  script:
    - docker build -t blitz2021/game .
    - docker tag blitz2021/game:latest $CI_REGISTRY/$CI_PROJECT_PATH/play:latest
    - docker tag blitz2021/game:latest $CI_REGISTRY/$CI_PROJECT_PATH/play:$CI_PIPELINE_ID
    - docker tag blitz2021/game 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:latest
    - docker tag blitz2021/game 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:$CI_PIPELINE_ID
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/play:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/play:$CI_PIPELINE_ID
    - docker push 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:latest
    - docker push 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:$CI_PIPELINE_ID
