stages:
  - build
  - dockerise
  - release

cache:
  paths:
    - node_modules/

build:
  image: node:14
  stage: build
  script:
    - yarn install
    - yarn build
    - yarn test
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    paths:
      - game/dist
      - ui/dist
  only:
    changes:
      - game/**/*
      - ui/**/*
      - gitlab-ci.yml

docker:
  stage: dockerise
  image: docker
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl jq python3 py3-pip
    - pip install awscli
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - $(aws ecr get-login --no-include-email --region us-east-1)
  script:
    - docker build -t blitz2021/local -f local.Dockerfile .
    - docker tag blitz2021/local:latest $CI_REGISTRY/$CI_PROJECT_PATH/play:latest
    - docker tag blitz2021/local:latest $CI_REGISTRY/$CI_PROJECT_PATH/play:$CI_PIPELINE_ID
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/play:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/play:$CI_PIPELINE_ID
    - docker build -t blitz2021/server -f server.Dockerfile .
    - docker tag blitz2021/server 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:latest
    - docker tag blitz2021/server 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:$CI_PIPELINE_ID
    - docker push 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:latest
    - docker push 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:$CI_PIPELINE_ID
    - docker tag blitz2021/local 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:local
    - docker push 043612128888.dkr.ecr.us-east-1.amazonaws.com/blitz2021/blitz2021:local
  only:
    changes:
      - game/**/*
      - ui/**/*
      - gitlab-ci.yml
    refs:
      - master

upload_starterkits:
  image: python:latest
  stage: release
  before_script:
    - pip install awscli
  script:
    - python -m zipfile -c starterpacks.zip starterpacks/
    - aws s3 cp starterpacks.zip s3://blitz-2020/
    - aws s3api put-object-acl --bucket blitz-2021 --key starterpacks.zip --acl public-read
  only:
    changes:
      - starterkits/**/*
      - gitlab-ci.yml
    refs:
      - master
